var M=Object.defineProperty;var N=(d,e,t)=>e in d?M(d,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):d[e]=t;var m=(d,e,t)=>(N(d,typeof e!="symbol"?e+"":e,t),t),w=(d,e,t)=>{if(!e.has(d))throw TypeError("Cannot "+t)};var i=(d,e,t)=>(w(d,e,"read from private field"),t?t.call(d):e.get(d)),h=(d,e,t)=>{if(e.has(d))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(d):e.set(d,t)},u=(d,e,t,o)=>(w(d,e,"write to private field"),o?o.call(d,t):e.set(d,t),t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))o(s);new MutationObserver(s=>{for(const r of s)if(r.type==="childList")for(const a of r.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&o(a)}).observe(document,{childList:!0,subtree:!0});function t(s){const r={};return s.integrity&&(r.integrity=s.integrity),s.referrerPolicy&&(r.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?r.credentials="include":s.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function o(s){if(s.ep)return;s.ep=!0;const r=t(s);fetch(s.href,r)}})();var f,y,L,T,E,S;class B{constructor({taskID:e=null,text:t,position:o,mass:s,district:r,adress:a}){h(this,f,"");h(this,y,"");h(this,L,-1);h(this,T,0);h(this,E,"");h(this,S,"");u(this,f,e||crypto.randomUUID()),u(this,y,t),u(this,L,o),u(this,T,s),u(this,E,r),u(this,S,a)}get taskID(){return i(this,f)}get taskText(){return i(this,y)}set taskText(e){typeof e=="string"&&u(this,y,e)}get taskDistrict(){return i(this,E)}set taskDistrict(e){typeof e=="string"&&u(this,E,e)}get taskAdress(){return i(this,S)}set taskAdress(e){typeof e=="string"&&u(this,S,e)}get taskPosition(){return i(this,L)}set taskPosition(e){typeof e=="number"&&e>=0&&u(this,L,e)}get taskMass(){return i(this,T)}set taskMass(e){typeof e=="number"&&e>=0&&u(this,T,e)}render(){const e=document.createElement("li");e.classList.add("courier__tasks-list-item","task"),e.setAttribute("id",i(this,f)),e.setAttribute("draggable",!0),e.addEventListener("dragstart",l=>{l.target.classList.add("task_selected"),localStorage.setItem("movedTaskID",i(this,f))}),e.addEventListener("dragend",l=>l.target.classList.remove("task_selected"));const t=document.createElement("span");t.classList.add("task__text"),t.innerHTML=i(this,y),e.appendChild(t);const o=document.createElement("span");o.classList.add("task__text"),o.innerHTML=i(this,E),e.appendChild(o);const s=document.createElement("span");s.classList.add("task__text"),s.innerHTML=i(this,S),e.appendChild(s);const r=document.createElement("span");r.classList.add("task__text"),r.innerHTML=i(this,T),e.appendChild(r);const a=document.createElement("div");a.classList.add("task__controls");const n=document.createElement("div");n.classList.add("task__controls-row");const c=document.createElement("button");return c.setAttribute("type","button"),c.classList.add("task__contol-btn","delete-icon"),c.addEventListener("click",()=>{localStorage.setItem("deleteTaskID",i(this,f));const l=document.getElementById("modal-delete-task");l.querySelector(".app-modal__question").innerHTML=`Задание '${i(this,y)}' будет удалено. Прододлжить?`,l.showModal()}),n.appendChild(c),a.appendChild(n),e.appendChild(a),e}}f=new WeakMap,y=new WeakMap,L=new WeakMap,T=new WeakMap,E=new WeakMap,S=new WeakMap;class D{static async getCouriers(){try{const e=await fetch("http://localhost:8080/couriers"),t=await e.json();return e.status!==200?Promise.reject(t):t.couriers}catch(e){return Promise.reject({timestamp:new Date().toISOString(),statusCode:0,message:e.message})}}static async addCourier({courierID:e,name:t,district:o}){try{const s=await fetch("http://localhost:8080/couriers",{method:"POST",body:JSON.stringify({courierID:e,name:t,district:o}),headers:{"Content-type":"application/json"}});if(s.status!==200){const r=await s.json();return Promise.reject(r)}return{timestamp:new Date().toISOString(),message:`Курьер ${t} был успешно добавлен`}}catch(s){return Promise.reject({timestamp:new Date().toISOString(),statusCode:0,message:s.message})}}static async addTask({taskID:e,text:t,mass:o,district:s,adress:r,courierID:a}){try{const n=await fetch("http://localhost:8080/tasks",{method:"POST",body:JSON.stringify({taskID:e,text:t,mass:o,district:s,adress:r,courierID:a}),headers:{"Content-type":"application/json"}});if(n.status!==200){const c=await n.json();return Promise.reject(c)}return{timestamp:new Date().toISOString(),message:`Задание ${t} было успешно добавлено`}}catch(n){return Promise.reject({timestamp:new Date().toISOString(),statusCode:0,message:n.message})}}static async updateCourier({courierID:e,name:t,district:o}){try{const s=await fetch(`http://localhost:8080/couriers/${e}`,{method:"PATCH",body:JSON.stringify({name:t,district:o}),headers:{"Content-type":"application/json"}});if(s.status!==200){const r=await s.json();return Promise.reject(r)}return{timestamp:new Date().toISOString(),message:`Курьер ${t} был успешно изменен`}}catch(s){return Promise.reject({timestamp:new Date().toISOString(),statusCode:0,message:s.message})}}static async deleteTask({taskID:e}){try{const t=await fetch(`http://localhost:8080/tasks/${e}`,{method:"DELETE"});if(t.status!==200){const o=await t.json();return Promise.reject(o)}return{timestamp:new Date().toISOString(),message:`Задание ${e} было успешно удалено`}}catch(t){return Promise.reject({timestamp:new Date().toISOString(),statusCode:0,message:t.message})}}static async moveTask({taskID:e,srcCourierID:t,destCourierID:o}){try{const s=await fetch("http://localhost:8080/couriers",{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({taskID:e,srcCourierID:t,destCourierID:o})});if(s.status!==200){const r=await s.json();return Promise.reject(r)}return{timestamp:new Date().toISOString(),message:`Задание ${e} было успешна перемещена`}}catch(s){return Promise.reject({timestamp:new Date().toISOString(),statusCode:0,message:s.message})}}}var p,C,k,I;class b{constructor({courierID:e=null,name:t,district:o,onDropTaskInCourier:s,addNotification:r}){h(this,p,[]);h(this,C,"");h(this,k,"");h(this,I,"");m(this,"pushTask",({task:e})=>i(this,p).push(e));m(this,"getTaskById",({taskID:e})=>i(this,p).find(t=>t.taskID===e));m(this,"getSumMass",()=>{let e=0;for(let t of i(this,p))e+=parseInt(t.taskMass);return e});m(this,"deleteTask",({taskID:e})=>{const t=i(this,p).findIndex(s=>s.taskID===e);if(t===-1)return;const[o]=i(this,p).splice(t,1);return o});m(this,"reorderTasks",()=>{Array.from(document.querySelector(`[id="${i(this,k)}"] .courier__tasks-list`).children,t=>t.getAttribute("id")).forEach((t,o)=>{i(this,p).find(s=>s.taskID===t).taskPosition=o})});m(this,"appendNewTask",async({text:e,district:t,adress:o,mass:s})=>{try{const r=crypto.randomUUID(),a=await D.addTask({taskID:r,text:e,mass:s,district:t,adress:o,courierID:i(this,k)});this.addNewTaskLocal({taskID:r,text:e,position:i(this,p).length,mass:s,district:t,adress:o}),this.addNotification({text:a.message,type:"success"})}catch(r){this.addNotification({text:r.message,type:"error"}),console.error(r)}});m(this,"addNewTaskLocal",({taskID:e=null,text:t,position:o,mass:s,district:r,adress:a})=>{const n=new B({taskID:e,text:t,position:o,mass:s,district:r,adress:a});i(this,p).push(n);const c=n.render();document.querySelector(`[id="${i(this,k)}"] .courier__tasks-list`).appendChild(c)});u(this,C,t),u(this,k,e||crypto.randomUUID()),u(this,I,o),this.onDropTaskInCourier=s,this.addNotification=r}get courierID(){return i(this,k)}get name(){return i(this,C)}set name(e){typeof e=="string"&&u(this,C,e)}get district(){return i(this,I)}set district(e){typeof e=="string"&&u(this,I,e)}render(){const e=document.createElement("li");e.classList.add("couriers-list__item","courier"),e.setAttribute("id",i(this,k)),e.addEventListener("dragstart",()=>localStorage.setItem("srcCourierID",i(this,k))),e.addEventListener("drop",this.onDropTaskInCourier);const t=document.createElement("div");t.classList.add("courier-list__item-header");const o=document.createElement("span");o.classList.add("courier__name"),o.innerHTML=i(this,C),t.appendChild(o);const s=document.createElement("span");s.classList.add("courier__district"),s.innerHTML=i(this,I),t.appendChild(s);const r=document.createElement("button");r.setAttribute("type","button"),r.classList.add("courier__edit-btn","edit-icon"),r.addEventListener("click",()=>{localStorage.setItem("editCourierID",i(this,k)),localStorage.setItem("district",i(this,I)),localStorage.setItem("tasksLength",i(this,p).length),document.getElementById("modal-edit-courier").showModal()}),t.appendChild(r),e.appendChild(t);const a=document.createElement("ul");a.classList.add("courier__tasks-list"),e.appendChild(a);const n=document.createElement("button");n.setAttribute("type","button"),n.classList.add("courier__add-task-btn"),n.innerHTML="&#10010; Добавить задание",n.addEventListener("click",()=>{let l=0;for(let v of i(this,p))l+=parseInt(v.taskMass);l<3?(localStorage.setItem("addTaskCourierID",i(this,k)),document.getElementById("modal-add-task").showModal()):this.addNotification({text:"Нельлзя добавить задание, максимум 3",type:"error"})}),e.appendChild(n);const c=document.querySelector(".courier-adder");c.parentElement.insertBefore(e,c)}}p=new WeakMap,C=new WeakMap,k=new WeakMap,I=new WeakMap;var g;class q{constructor(){h(this,g,[]);m(this,"onEscapeKeydown",e=>{if(e.key==="Escape"){const t=document.querySelector(".courier-adder__input");t.style.display="none",t.value="",document.querySelector(".courier-adder__btn").style.display="inherit"}});m(this,"onDropTaskInCourier",async e=>{e.stopPropagation();const t=e.currentTarget;t.classList.remove("courier_droppable");const o=localStorage.getItem("movedTaskID"),s=localStorage.getItem("srcCourierID"),r=t.getAttribute("id");if(localStorage.setItem("movedTaskID",""),localStorage.setItem("srcCourierID",""),!t.querySelector(`[id="${o}"]`))return;const a=i(this,g).find(l=>l.courierID===s),n=i(this,g).find(l=>l.courierID===r),c=a.getTaskById({taskID:o});if(c.taskDistrict===n.district)if(parseInt(n.getSumMass())+parseInt(c.taskMass)<=3)try{if(s!==r){await D.moveTask({taskID:o,srcCourierID:s,destCourierID:r});const l=a.deleteTask({taskID:o});n.pushTask({task:l}),a.reorderTasks()}n.reorderTasks(),this.addNotification({text:`Задание  ${o} перемещена между курьерами`,type:"success"})}catch(l){this.addNotification({text:l.message,type:"error"}),console.error(l)}else alert("Количество заданий превышено"),location.reload(),this.addNotification({text:"Количество заданий превышено",type:"error"});else alert("Нельзя добавить задание с другим регионом курьеру"),location.reload(),setTimeout(()=>5e3),this.addNotification({text:"Нельзя добавить задание с другим регионом курьеру",type:"error"})});m(this,"editCourier",async({courierID:e,newName:t,newDistrict:o})=>{let s=null;s=i(this,g).find(a=>a.courierID===e);const r=s.name;if(!(!r||t===r))try{const a=await D.updateCourier({courierID:e,name:t,district:o});s.name=t,s.district=o,document.querySelector(`[id="${e}"] span.courier__name`).innerHTML=t,document.querySelector(`[id="${e}"] span.courier__district`).innerHTML=o}catch(a){this.addNotification({text:a.message,type:"error"}),console.error(a)}});m(this,"deleteTask",async({taskID:e})=>{let t=null,o=null;for(let s of i(this,g))if(o=s,t=s.getTaskById({taskID:e}),t)break;try{const s=await D.deleteTask({taskID:e});o.deleteTask({taskID:e}),document.getElementById(e).remove(),this.addNotification({text:s.message,type:"success"})}catch(s){this.addNotification({text:s.message,type:"error"}),console.error(s)}});m(this,"addNotification",({text:e,type:t})=>{const o=document.getElementById("app-notifications"),s=crypto.randomUUID(),r=document.createElement("div");r.classList.add("notification",t==="success"?"notification-success":"notification-error"),r.setAttribute("id",s),r.innerHTML=e,o.appendChild(r),setTimeout(()=>{document.getElementById(s).remove()},5e3)})}initAddCourierModal(){const e=document.getElementById("modal-add-courier"),t=()=>{e.close(),e.querySelector(".app-modal__input").value=""},o=async()=>{const s=crypto.randomUUID(),r=document.getElementById("modal-add-courier-input"),a=document.getElementById("modal-add-courier-selector");if(r.value&&a.value)try{const n=await D.addCourier({courierID:s,name:r.value,district:a.value}),c=new b({courierID:s,name:r.value,district:a.value,onDropTaskInCourier:this.onDropTaskInCourier,addNotification:this.addNotification});i(this,g).push(c),c.render(),this.addNotification({text:n.message,type:"success"})}catch(n){this.addNotification({text:n.message,type:"error"}),console.error(n)}t()};e.querySelector(".modal-ok-btn").addEventListener("click",o),e.querySelector(".modal-cancel-btn").addEventListener("click",t),e.addEventListener("close",t)}initAddTaskModal(){const e=document.getElementById("modal-add-task"),t=()=>{e.close(),localStorage.setItem("addTaskCourierID",""),e.querySelector(".app-modal__input").value="",document.getElementById("modal-add-task-input-adress").value=""},o=()=>{const s=localStorage.getItem("addTaskCourierID"),r=document.getElementById("modal-add-task-input"),a=document.getElementById("modal-add-task-input-adress"),n=document.getElementById("modal-add-task-selector-mass"),c=document.getElementById("modal-add-task-selector"),l=i(this,g).find(_=>_.courierID===s);l.getSumMass()+parseInt(n.value)<=3?c.value===l.district?s&&r.value&&a.value&&n.value&&c.value&&i(this,g).find(_=>_.courierID===s).appendNewTask({text:r.value,district:c.value,adress:a.value,mass:n.value}):this.addNotification({text:"Невозможно добавить задание с другим районом"}):this.addNotification({text:"Невозможно добавить задание, максимум вес - 3"}),t()};e.querySelector(".modal-ok-btn").addEventListener("click",o),e.querySelector(".modal-cancel-btn").addEventListener("click",t),e.addEventListener("close",t)}initEditCourierModal(){const e=document.getElementById("modal-edit-courier"),t=()=>{e.close(),localStorage.setItem("editTaskID",""),e.querySelector(".app-modal__input").value=""},o=()=>{const s=localStorage.getItem("editCourierID"),r=localStorage.getItem("district"),a=localStorage.getItem("tasksLength"),n=document.getElementById("modal-edit-courier-input"),c=document.getElementById("modal-edit-courier-selector");console.log(a),s&&n.value&&(a==="0"?(console.log("here"),this.editCourier({courierID:s,newName:n.value,newDistrict:c.value})):c.value===r&&a!=="0"?this.editCourier({courierID:s,newName:n.value,newDistrict:c.value}):alert("Нельзя изменить район курьера если у него есть задания")),t()};e.querySelector(".modal-ok-btn").addEventListener("click",o),e.querySelector(".modal-cancel-btn").addEventListener("click",t),e.addEventListener("close",t)}initDeleteTaskModal(){const e=document.getElementById("modal-delete-task"),t=()=>{e.close(),localStorage.setItem("deleteTaskID","")},o=()=>{const s=localStorage.getItem("deleteTaskID");s&&this.deleteTask({taskID:s}),t()};e.querySelector(".modal-ok-btn").addEventListener("click",o),e.querySelector(".modal-cancel-btn").addEventListener("click",t),e.addEventListener("close",t)}initNotifications(){document.getElementById("app-notifications").show()}async init(){document.querySelector(".courier-adder__btn").addEventListener("click",e=>{document.getElementById("modal-add-courier").showModal()}),document.addEventListener("keydown",this.onEscapeKeydown),this.initAddTaskModal(),this.initEditCourierModal(),this.initDeleteTaskModal(),this.initNotifications(),this.initAddCourierModal(),document.addEventListener("dragover",e=>{e.preventDefault();const t=document.querySelector(".task.task_selected"),o=t.closest(".courier"),s=e.target,r=document.querySelector(".courier_droppable");let a=e.target;for(;!a.matches(".courier")&&a!==document.body;)a=a.parentElement;if(a!==r&&(r&&r.classList.remove("courier_droppable"),a.matches(".courier")&&a.classList.add("courier_droppable")),!(!a.matches(".courier")||t===s)){if(a===o){if(!s.matches(".task"))return;const n=s===t.nextElementSibling?s.nextElementSibling:s;a.querySelector(".courier__tasks-list").insertBefore(t,n);return}if(s.matches(".task")){a.querySelector(".courier__tasks-list").insertBefore(t,s);return}a.querySelector(".courier__tasks-list").children.length||a.querySelector(".courier__tasks-list").appendChild(t)}});try{const e=await D.getCouriers();for(const t of e){const o=new b({courierID:t.courierID,name:t.name,district:t.district,onDropTaskInCourier:this.onDropTaskInCourier,addNotification:this.addNotification});i(this,g).push(o),o.render();let s=0;for(const r of t.tasks)o.addNewTaskLocal({taskID:r.taskID,text:r.text,position:s,mass:r.mass,district:r.district,adress:r.adress}),s+=1}}catch(e){this.addNotification({text:e.message,type:"error"}),console.error(e)}}}g=new WeakMap;document.addEventListener("DOMContentLoaded",()=>{new q().init()});
